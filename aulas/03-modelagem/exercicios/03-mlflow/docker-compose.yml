version: "3.9"

services:
  db:
    image: postgres:15
    environment:
      POSTGRES_DB: mlflowdb
      POSTGRES_USER: mlflow
      POSTGRES_PASSWORD: mlflow
    ports:
      - "5433:5432"      # acesso via localhost:5433
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mlflow -d mlflowdb"]
      interval: 5s
      timeout: 5s
      retries: 30
    volumes:
      - mlflow_pg:/var/lib/postgresql/data

  init-artifacts:
    image: busybox:1.36
    command: ["sh", "-c", "mkdir -p /artifacts && chmod -R 777 /artifacts"]
    volumes:
      - mlflow_artifacts:/artifacts
    restart: "no"

  mlflow:
    image: ghcr.io/mlflow/mlflow:v3.1.1
    depends_on:
      db:
        condition: service_healthy
      init-artifacts:
        condition: service_completed_successfully
    ports:
      - "5001:5000"                 # UI â†’ http://localhost:5001
    volumes:
      - mlflow_artifacts:/artifacts:rw
    user: "0:0"
    environment:
      MLFLOW_ENABLE_ARTIFACTS_SERVER: "true"
    entrypoint: bash -lc "pip install --no-cache-dir psycopg2-binary==2.9.9 && \
      mlflow server \
        --host 0.0.0.0 \
        --port 5000 \
        --backend-store-uri postgresql+psycopg2://mlflow:mlflow@db:5432/mlflowdb \
        --registry-store-uri postgresql+psycopg2://mlflow:mlflow@db:5432/mlflowdb \
        --serve-artifacts \
        --artifacts-destination file:///artifacts"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/health')"]
      interval: 5s
      timeout: 3s
      retries: 30
    restart: unless-stopped

volumes:
  mlflow_pg:
  mlflow_artifacts:
